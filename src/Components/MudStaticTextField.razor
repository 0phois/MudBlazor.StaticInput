@namespace MudBlazor.StaticInput
@typeparam T

@inherits MudTextField<T>

@{
    base.BuildRenderTree(__builder);
}

@code {
    /// <summary>
    ///     The name of the JavaScript function that will be invoked when the adornment (button) inside this <see cref="MudStaticTextField{T}"/> is clicked
    /// </summary>
    /// <remarks>
    /// <term>Parameters</term>
    /// <description>(required)</description>
    /// <list type="bullet">
    ///     <item>
    ///         <term>inputElement</term>
    ///         <description>The input element associated with the <see cref="MudStaticTextField{T}"/>.</description>
    ///     </item>
    ///     <item>
    ///         <term>eventTrigger</term>
    ///         <description>The button element (adornment button) that triggered the event.</description>
    ///     </item>
    /// </list>
    /// <example>
    ///     Example: Setting the AdornmentClickFunction to "showPassword" executes the 'showPassword' function when clicked.    
    /// <code>
    /// -------------------------------------------------
    /// MudStaticTextField @bind-Value="@Input.Password" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.Lock"
    ///                    AdornmentClickFunction="showPassword" InputType="InputType.Password" For="() => Input.Password"
    /// -------------------------------------------------
    /// </code>
    /// <code>
    ///    const passwordTimeouts = new WeakMap();
    ///    function showPassword(inputElement) {
    ///        if (!inputElement) return;
    ///
    ///        const existingTimeout = passwordTimeouts.get(inputElement);
    ///        if (existingTimeout) clearTimeout(existingTimeout);
    ///
    ///        if (inputElement.type === 'password') {
    ///            inputElement.type = 'text';
    ///            const timeoutId = setTimeout(function () {
    ///                inputElement.type = 'password';
    ///                passwordTimeouts.delete(inputElement);
    ///            }, 5000);
    ///            passwordTimeouts.set(inputElement, timeoutId);
    ///        } else {
    ///            inputElement.type = 'password';
    ///            passwordTimeouts.delete(inputElement);
    ///        }
    ///    }
    /// </code>
    /// ------------------------------------------------------------------------
    /// </example>
    /// </remarks>
    [Parameter] public string? AdornmentClickFunction { get; set; }
    [Parameter] public string? AdornmentToggledIcon { get; set; }
    [Parameter] public Expression<Func<string>>? ValueExpression { get; set; }

    private string _name = string.Empty;
    private bool HasDefaultContent => ShrinkLabel || 
                                      HasNativeHtmlPlaceholder() ||
                                      Adornment == Adornment.Start || 
                                      !string.IsNullOrWhiteSpace(Placeholder);

    protected override void OnParametersSet()
    {
        if (IsStatic())
        {
            UserAttributes["data-mud-static-type"] = "text-field";
            UserAttributes["data-mud-static-shrink"] = HasDefaultContent.ToString().ToLower();
            UserAttributes["data-mud-static-helper-focus"] = HelperTextOnFocus.ToString().ToLower();
            UserAttributes["data-mud-static-adornment-click"] = AdornmentClickFunction;
            UserAttributes["data-mud-static-icon"] = AdornmentIcon;
            UserAttributes["data-mud-static-toggle-icon"] = AdornmentToggledIcon;
            UserAttributes["name"] = _name;

            if (AdornmentClickFunction is not null)
            {
                base.OnAdornmentClick = EventCallback.Factory.Create<MouseEventArgs>(this, _ => { });
            }
        }
        else
        {
            UserAttributes.Remove("data-mud-static-type");
            UserAttributes.Remove("data-mud-static-shrink");
            UserAttributes.Remove("data-mud-static-helper-focus");
            UserAttributes.Remove("data-mud-static-adornment-click");
            UserAttributes.Remove("data-mud-static-icon");
            UserAttributes.Remove("data-mud-static-toggle-icon");
            UserAttributes.Remove("data-mud-static-initialized");
        }
        
        base.OnParametersSet();
    }

    protected override void OnInitialized()
    {
        var expression = ValueExpression?.ToString();

        if (!string.IsNullOrEmpty(expression))
        {
            var index = expression.LastIndexOf(").", StringComparison.Ordinal);

            if (index > 0)
            {
                _name = expression[(index + 2)..];       
            }
        }

        base.OnInitialized();
    }

    private bool HasNativeHtmlPlaceholder()
    {
        return InputType is InputType.Color or 
               InputType.DateTimeLocal or
               InputType.Date or
               InputType.Month or 
               InputType.Week or
               InputType.Time;
    }
}
